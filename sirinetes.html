<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Reminder & Jadwal Kerja</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-light d-flex justify-content-center align-items-center vh-100"
  >
    <div
      class="card shadow-lg text-center"
      style="max-width: 500px; width: 100%"
    >
      <div class="card-body">
        <h3 class="card-title mb-4">⏰ Reminder & Jadwal Kerja</h3>

        <!-- Tombol -->
        <div class="d-flex justify-content-center gap-2 mb-4">
          <button class="btn btn-success" onclick="startReminder()">
            <i class="bi bi-play-fill"></i> Mulai
          </button>
          <button class="btn btn-danger" onclick="stopReminder()">
            <i class="bi bi-stop-fill"></i> Stop
          </button>
        </div>

        <!-- Reminder -->
        <div class="p-3 bg-white rounded mb-3 border">
          <p id="countdownReminder" class="mb-0 fw-bold text-primary">
            <i class="bi bi-bell-fill"></i> Reminder umum berikutnya: -
          </p>
        </div>

        <!-- Sirine -->
        <div class="p-3 bg-white rounded border">
          <p id="countdownText" class="mb-0 fw-bold text-danger">
            <i class="bi bi-broadcast-pin"></i> Alarm berikutnya: -
          </p>
        </div>
      </div>
    </div>

    <!-- Reminder beep -->
    <audio
      id="reminderSound"
      src="Alarm-Clock Sound!!!.mp3"
      preload="auto"
    ></audio>

    <!-- Sirine -->
    <audio
      id="sirineSound"
      src="air-raid-siren-sound-effect-241383.mp3"
      preload="auto"
    ></audio>

    <script>
      let scheduleChecker;
      let reminderCountdownTimer;
      let sirineActive = false;

      // Reminder 1 jam sekali
      const reminderIntervalMs = 3600000; // 1 jam = 3600000 ms
      let nextReminderTime = null; // jadwal reminder berikutnya

      // Jadwal Senin–Kamis & Jumat
      const schedule = {
        MonThu: ["08:00:00", "12:00:00", "13:00:00", "17:00:00"],
        Fri: ["08:00:00", "11:30:00", "12:30:00", "17:00:00"],
      };

      function startReminder() {
        if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }

        scheduleNextReminder(); // buat jadwal reminder pertama

        // Cek jadwal tiap detik
        scheduleChecker = setInterval(() => {
          checkSchedule();
          updateCountdownSchedule();
          checkReminder(); // cek apakah sudah waktunya reminder
        }, 1000);

        alert(
          "Reminder aktif setiap 1 jam. Sirine sesuai jadwal Senin–Kamis & Jumat."
        );
      }

      function stopReminder() {
        clearInterval(scheduleChecker);
        clearInterval(reminderCountdownTimer);
        nextReminderTime = null;
        document.getElementById("countdownReminder").innerHTML =
          '<i class="bi bi-bell-fill"></i> Reminder umum berikutnya: -';
        document.getElementById("countdownText").innerHTML =
          '<i class="bi bi-broadcast-pin"></i> Alarm berikutnya: -';
      }

      function scheduleNextReminder() {
        const now = new Date();
        let candidate = new Date(now.getTime() + reminderIntervalMs);

        // cari jam berikutnya yang tidak tabrakan dengan jadwal sirine
        while (isConflictWithSchedule(candidate)) {
          candidate = new Date(candidate.getTime() + reminderIntervalMs);
        }

        nextReminderTime = candidate;
        startReminderCountdown();
      }

      function checkReminder() {
        if (!nextReminderTime) return;

        const now = new Date();
        if (now >= nextReminderTime) {
          triggerReminder();
          scheduleNextReminder();
        }
      }

      function triggerReminder() {
        if (sirineActive) {
          console.log("Reminder dilewati karena sirine sedang aktif.");
          scheduleNextReminder();
          return;
        }

        let reminder = document.getElementById("reminderSound");
        reminder.currentTime = 0;
        reminder.play();

        if (Notification.permission === "granted") {
          new Notification("Reminder!", {
            body: "Sudah waktunya tetap terjaga!",
          });
        }
      }

      function startReminderCountdown() {
        clearInterval(reminderCountdownTimer);

        reminderCountdownTimer = setInterval(() => {
          if (!nextReminderTime) return;

          const now = new Date();
          let diff = Math.floor((nextReminderTime - now) / 1000);

          if (diff <= 0) {
            clearInterval(reminderCountdownTimer);
            return;
          }

          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;

          document.getElementById(
            "countdownReminder"
          ).innerHTML = `<i class="bi bi-bell-fill"></i> Reminder umum berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }, 1000);
      }

      function getTodaySchedule() {
        const day = new Date().getDay(); // 0=Sunday, 1=Monday,...,5=Friday
        if (day >= 1 && day <= 4) return schedule["MonThu"];
        if (day === 5) return schedule["Fri"];
        return []; // Sabtu/Minggu kosong
      }

      function isConflictWithSchedule(date) {
        const todaySchedule = getTodaySchedule();
        const timeStr =
          date.getHours().toString().padStart(2, "0") +
          ":" +
          date.getMinutes().toString().padStart(2, "0") +
          ":00";
        return todaySchedule.includes(timeStr);
      }

      function checkSchedule() {
        const now = new Date();
        const currentTime =
          now.getHours().toString().padStart(2, "0") +
          ":" +
          now.getMinutes().toString().padStart(2, "0") +
          ":" +
          now.getSeconds().toString().padStart(2, "0");

        const todaySchedule = getTodaySchedule();
        if (todaySchedule.includes(currentTime)) {
          playSirine("Alarm jadwal pada " + currentTime);
        }
      }

      function playSirine(msg) {
        sirineActive = true;

        let sirine = document.getElementById("sirineSound");
        sirine.currentTime = 0;
        sirine.play();

        if (Notification.permission === "granted") {
          new Notification("Jadwal Kerja!", { body: msg });
        }
        document.getElementById(
          "countdownText"
        ).innerHTML = `<i class="bi bi-broadcast-pin"></i> ${msg}`;

        // Anggap durasi sirine 15 detik
        setTimeout(() => {
          sirine.pause();
          sirine.currentTime = 0;
          sirineActive = false;
        }, 15000);
      }

      function updateCountdownSchedule() {
        const now = new Date();
        const todaySchedule = getTodaySchedule();
        let nextAlarm = null;

        for (let t of todaySchedule) {
          let [h, m, s] = t.split(":").map(Number);
          let alarmTime = new Date(now);
          alarmTime.setHours(h, m, s, 0);
          if (alarmTime > now) {
            nextAlarm = alarmTime;
            break;
          }
        }

        if (!nextAlarm) {
          document.getElementById("countdownText").innerHTML =
            '<i class="bi bi-broadcast-pin"></i> Tidak ada alarm berikutnya hari ini.';
          return;
        }

        let diff = Math.floor((nextAlarm - now) / 1000);
        let minutes = Math.floor(diff / 60);
        let seconds = diff % 60;

        const timeStr = nextAlarm.toTimeString().split(" ")[0].slice(0, 5);
        document.getElementById(
          "countdownText"
        ).innerHTML = `<i class="bi bi-broadcast-pin"></i> Alarm berikutnya: ${timeStr} (${minutes} menit ${seconds} detik lagi)`;
      }
    </script>
  </body>
</html>
