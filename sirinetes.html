<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reminder & Jadwal Kerja</title>

    <link href="bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet" />

    <style>
      #clock {
        font-size: 60px;
        font-weight: bold;
        color: white;
        background: rgb(255, 187, 0);
        padding: 20px 40px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        transition: font-size 0.3s ease, padding 0.3s ease; /* Transisi untuk responsivitas yang halus */
      }

      /* Media Query untuk membuat tampilan lebih baik di layar sempit (ponsel) */
      @media (max-width: 576px) {
        #clock {
          font-size: 40px; /* Ukuran font lebih kecil */
          padding: 15px 30px;
        }
        .card {
          margin: 10px; /* Tambahkan margin agar tidak menempel di pinggir layar */
        }
        .card-body {
          padding: 15px; /* Kurangi padding card body */
        }
      }
    </style>
  </head>
  <body
    class="bg-light d-flex justify-content-center align-items-center vh-100 p-3"
  >
    <div
      class="card shadow-lg text-center"
      style="max-width: 500px; width: 100%"
    >
      <div class="card-body">
        <div id="clock" class="mb-4">00:00:00</div>
        <h3 class="card-title mb-4">‚è∞ Reminder & Jadwal Kerja</h3>

        <div class="d-flex justify-content-center gap-2 mb-2">
          <button class="btn btn-success" onclick="startReminder()">
            <i class="bi bi-play-fill"></i> Mulai
          </button>
          <button class="btn btn-danger flex-fill" onclick="stopReminder()">
            <i class="bi bi-stop-fill"></i> Stop
          </button>
        </div>

        <p id="startTime" class="fw-bold text-info mb-4">
          <i class="bi bi-clock-history"></i> Waktu mulai: -
        </p>

        <div class="p-3 bg-white rounded mb-3 border">
          <p id="countdownReminder" class="mb-0 fw-bold text-primary">
            <i class="bi bi-bell-fill"></i> Reminder umum berikutnya: -
          </p>
        </div>

        <div class="p-3 bg-white rounded mb-3 border">
          <p id="countdownText" class="mb-0 fw-bold text-danger">
            <i class="bi bi-broadcast-pin"></i> Alarm berikutnya: -
          </p>
        </div>

        <div class="p-3 bg-white rounded border">
          <p id="nationalBlockCountdown" class="mb-0 fw-bold text-primary">
            <i class="bi bi-music-note-beamed"></i> Blok Nasional (IR & Hymne):
            -
          </p>
        </div>
      </div>
    </div>

    <audio id="reminderSound" src="chime-2-356833.mp3" preload="auto"></audio>

    <audio
      id="sirineSound"
      src="air-raid-siren-sound-effect-241383.mp3"
      preload="auto"
    ></audio>

    <audio id="indonesiaRaya" src="Indonesia Raya.mp3" preload="auto"></audio>

    <audio id="anthem" src="Hymne Sinar Mas.mp3" preload="auto"></audio>

    <script>
      let scheduleChecker;
      let reminderCountdownTimer;
      let sirineActive = false;
      let nationalBlockActive = false; // Flag Utama untuk Blok Nasional

      // Flag pemutaran harian
      let nationalBlockStarted = false;
      let lastNationalBlockDate = null;

      // Durasi Lagu (dalam detik)
      const indonesiaRayaDuration = 110; // 1m50s
      const anthemDuration = 145; // 2m25s detik
      const totalBlockDuration = indonesiaRayaDuration + anthemDuration; // Total: 255 detik (4 menit 15 detik)

      // Waktu Mulai Blok Nasional (Indonesia Raya)
      const nationalBlockStartHour = 8;
      const nationalBlockStartMinute = 30;
      const nationalBlockStartSecond = 0;

      // Reminder 1 jam sekali (dalam milidetik)
      const reminderIntervalMs = 3600000; // 1 jam
      let nextReminderTime = null;

      // Jadwal Sirine Harian (Senin‚ÄìJumat)
      const schedule = {
        MonThu: ["08:00:00", "12:00:00", "13:00:00", "17:00:00"],
        Fri: ["08:00:00", "11:30:00", "12:30:00", "17:00:00"],
      };

      // ================== Start & Stop ===================
      function startReminder() {
        if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }

        // V PENTING: Muat semua audio di awal untuk mengatasi pembatasan Autoplay Browser V
        document.getElementById("reminderSound").load();
        document.getElementById("sirineSound").load();
        document.getElementById("indonesiaRaya").load();
        document.getElementById("anthem").load();
        // ^=======================================================================^

        const now = new Date();
        const days = [
          "Minggu",
          "Senin",
          "Selasa",
          "Rabu",
          "Kamis",
          "Jumat",
          "Sabtu",
        ];
        const dayName = days[now.getDay()];
        const dateStr = now.toLocaleDateString("id-ID");
        const timeStr = now.toLocaleTimeString("id-ID");

        document.getElementById(
          "startTime"
        ).innerHTML = `<i class="bi bi-clock-history"></i> Waktu mulai: ${dayName}, ${dateStr} ${timeStr}`;

        // Mendapatkan waktu start Blok Nasional hari ini
        const startBlock = getNationalBlockStartTime();

        // LOGIKA TAMBAHAN: Cek apakah waktu saat ini (now) sudah melewati jadwal Blok Nasional hari ini.
        // Jika sudah melewati dan tanggalnya sama, anggap sudah diputar.
        if (
          startBlock < now &&
          startBlock.toDateString() === now.toDateString()
        ) {
          nationalBlockStarted = true;
          lastNationalBlockDate = now.toDateString();
        } else {
          nationalBlockStarted = false; // Akan dipicu saat 07:50:00
        }

        scheduleNextReminder();

        // Stop dulu jika sudah berjalan
        if (scheduleChecker) stopReminder();

        scheduleChecker = setInterval(() => {
          checkSchedule(); // Cek Sirine Jadwal
          checkNationalBlock(); // Cek Blok Nasional
          checkReminder();
          updateCountdownSchedule();
          updateNationalBlockCountdown();
        }, 1000);

        alert(
          `Jadwal Prioritas Aktif. Blok Nasional diputar sekali setiap hari pada ${nationalBlockStartHour
            .toString()
            .padStart(2, "0")}:${nationalBlockStartMinute
            .toString()
            .padStart(2, "0")}.`
        );
      }

      function stopReminder() {
        clearInterval(scheduleChecker);
        scheduleChecker = null;
        clearInterval(reminderCountdownTimer);
        nextReminderTime = null;
        sirineActive = false;
        nationalBlockActive = false;
        // Jangan reset nationalBlockStarted di stop, agar status harian tetap terjaga
        // nationalBlockStarted = false;

        // Hentikan semua audio dan reset currentTime
        const audios = [
          "reminderSound",
          "sirineSound",
          "indonesiaRaya",
          "anthem",
        ];
        audios.forEach((id) => {
          const audio = document.getElementById(id);
          audio.pause();
          audio.currentTime = 0;
        });

        document.getElementById("countdownReminder").innerHTML =
          '<i class="bi bi-bell-fill"></i> Reminder umum berikutnya: -';
        document.getElementById("countdownText").innerHTML =
          '<i class="bi bi-broadcast-pin"></i> Alarm berikutnya: -';
        document.getElementById("nationalBlockCountdown").innerHTML =
          '<i class="bi bi-music-note-beamed"></i> Blok Nasional (IR & Hymne): -'; // Menggunakan ID yang disederhanakan
        document.getElementById("startTime").innerHTML =
          '<i class="bi bi-clock-history"></i> Waktu mulai: -';
      }

      // ================== Blok Nasional (Indonesia Raya + Hymne) ===================

      function getNationalBlockStartTime() {
        const today = new Date();
        let start = new Date(today);
        start.setHours(
          nationalBlockStartHour,
          nationalBlockStartMinute,
          nationalBlockStartSecond,
          0
        );
        return start;
      }

      function checkNationalBlock() {
        if (nationalBlockStarted) return;

        const now = new Date();
        const start = getNationalBlockStartTime();

        // Ini seharusnya tidak perlu lagi jika logika startReminder() sudah benar,
        // tapi dipertahankan untuk keamanan
        if (lastNationalBlockDate === now.toDateString()) return;

        // Dipicu tepat pada detik pertama
        if (now >= start && now <= new Date(start.getTime() + 1000)) {
          playNationalBlock();
          nationalBlockStarted = true;
          lastNationalBlockDate = now.toDateString();
        }
      }

      function playNationalBlock() {
        nationalBlockActive = true;

        let indo = document.getElementById("indonesiaRaya");
        let hymne = document.getElementById("anthem");

        if (Notification.permission === "granted") {
          new Notification("Blok Nasional!", {
            body: "Memutar Indonesia Raya diikuti Hymne Sinarmas.",
          });
        }
        document.getElementById("nationalBlockCountdown").innerHTML =
          '<i class="bi bi-music-note-beamed"></i> üé∂ Sedang memutar: Blok Nasional (IR ‚Üí Hymne)'; // Menggunakan ID yang disederhanakan

        // 1. Mainkan Indonesia Raya
        indo.currentTime = 0;
        indo.play();

        // 2. Setelah IR selesai (berdasarkan durasi 110s) ‚Üí lanjut Hymne
        setTimeout(() => {
          indo.pause();
          indo.currentTime = 0;
          hymne.currentTime = 0;
          hymne.play();

          // 3. Setelah Hymne selesai (setelah 145s tambahan) ‚Üí Blok selesai
          setTimeout(() => {
            hymne.pause();
            hymne.currentTime = 0;
            nationalBlockActive = false;
            // Perbarui tampilan setelah blok selesai
            updateNationalBlockCountdown();
          }, anthemDuration * 1000);
        }, indonesiaRayaDuration * 1000);
      }

      function updateNationalBlockCountdown() {
        // Jika blok sedang aktif diputar, biarkan teks tetap "Sedang memutar..."
        if (nationalBlockActive) {
          return;
        }

        const now = new Date();
        const start = getNationalBlockStartTime();

        if (now < start) {
          let diff = Math.floor((start - now) / 1000);
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "nationalBlockCountdown" // Menggunakan ID yang disederhanakan
          ).innerHTML = `<i class="bi bi-music-note-beamed"></i> Blok Nasional akan diputar dalam ${minutes} menit ${seconds} detik`;
        } else {
          // KONDISI SUDAH LEWAT: Menampilkan notifikasi "sudah diputar hari ini."
          document.getElementById("nationalBlockCountdown").innerHTML =
            '<i class="bi bi-music-note-beamed"></i> Blok Nasional: sudah diputar hari ini.'; // Menggunakan ID yang disederhanakan
        }
      }

      // ================== Reminder & Anti-Tabrak ===================

      function getTodaySchedule() {
        const day = new Date().getDay();
        if (day >= 1 && day <= 4) return schedule["MonThu"];
        if (day === 5) return schedule["Fri"];
        return []; // Sabtu dan Minggu
      }

      function isConflictWithSchedule(date) {
        // 1. Cek konflik dengan Jadwal Sirine (tepat pada menit/jam yang dijadwalkan)
        const todaySchedule = getTodaySchedule();
        const timeStr =
          date.getHours().toString().padStart(2, "0") +
          ":" +
          date.getMinutes().toString().padStart(2, "0") +
          ":00";
        if (todaySchedule.includes(timeStr)) return true;

        // 2. Cek konflik dengan Durasi Total Blok Nasional (IR + Hymne)
        const startBlock = getNationalBlockStartTime();
        const endBlock = new Date(
          startBlock.getTime() + totalBlockDuration * 1000
        );

        if (
          date.toDateString() === startBlock.toDateString() &&
          date >= startBlock &&
          date < endBlock
        ) {
          return true;
        }

        return false;
      }

      function scheduleNextReminder() {
        const now = new Date();
        let candidate = new Date(now.getTime() + reminderIntervalMs);

        // Logic untuk menghindari konflik dengan semua jadwal prioritas
        while (isConflictWithSchedule(candidate)) {
          // Jika ada konflik, majukan 1 interval penuh (1 jam)
          candidate = new Date(candidate.getTime() + reminderIntervalMs);
        }

        nextReminderTime = candidate;
        startReminderCountdown();
      }

      function checkReminder() {
        if (!nextReminderTime) return;

        const now = new Date();
        if (now >= nextReminderTime) {
          triggerReminder();
          scheduleNextReminder();
        }
      }

      function triggerReminder() {
        // Logika prioritas: Reminder dilewati jika Sirine atau Blok Nasional sedang aktif
        if (sirineActive || nationalBlockActive) {
          console.log(
            "Reminder dilewati karena ada event prioritas lebih tinggi."
          );
          return;
        }

        let reminder = document.getElementById("reminderSound");
        reminder.currentTime = 0;
        reminder.play();

        if (Notification.permission === "granted") {
          new Notification("Reminder!", {
            body: "Sudah waktunya tetap terjaga!",
          });
        }
      }

      function startReminderCountdown() {
        clearInterval(reminderCountdownTimer);
        reminderCountdownTimer = setInterval(() => {
          if (!nextReminderTime) return;
          const now = new Date();
          let diff = Math.floor((nextReminderTime - now) / 1000);
          if (diff <= 0) {
            clearInterval(reminderCountdownTimer);
            return;
          }
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownReminder"
          ).innerHTML = `<i class="bi bi-bell-fill"></i> Reminder umum berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }, 1000);
      }

      // ================== Sirine Jadwal (Jadwal Kerja) ===================

      function checkSchedule() {
        const now = new Date();
        const currentTime =
          now.getHours().toString().padStart(2, "0") +
          ":" +
          now.getMinutes().toString().padStart(2, "0") +
          ":" +
          now.getSeconds().toString().padStart(2, "0");

        const todaySchedule = getTodaySchedule();
        if (todaySchedule.includes(currentTime)) {
          playSirine("Alarm jadwal pada " + currentTime);
        }
      }

      function playSirine(msg) {
        // Logika prioritas: Sirine dilewati jika Blok Nasional sedang aktif
        if (nationalBlockActive) {
          console.log("Sirine dilewati karena Blok Nasional sedang aktif.");
          return;
        }

        sirineActive = true;
        let sirine = document.getElementById("sirineSound");
        sirine.currentTime = 0;
        sirine.play();

        if (Notification.permission === "granted") {
          new Notification("Jadwal Kerja!", { body: msg });
        }
        document.getElementById(
          "countdownText"
        ).innerHTML = `<i class="bi bi-broadcast-pin"></i> ${msg}`;

        // Sirine berhenti setelah 15 detik
        setTimeout(() => {
          sirine.pause();
          sirine.currentTime = 0;
          sirineActive = false;
          updateCountdownSchedule(); // Perbarui teks countdown setelah sirine berhenti
        }, 15000);
      }

      function updateCountdownSchedule() {
        const now = new Date();
        const todaySchedule = getTodaySchedule();
        let nextAlarm = null;

        for (let t of todaySchedule) {
          let [h, m, s] = t.split(":").map(Number);
          let alarmTime = new Date(now);
          alarmTime.setHours(h, m, s, 0);
          if (alarmTime > now) {
            nextAlarm = alarmTime;
            break;
          }
        }

        if (!nextAlarm) {
          document.getElementById("countdownText").innerHTML =
            '<i class="bi bi-broadcast-pin"></i> Tidak ada alarm berikutnya hari ini.';
          return;
        }

        if (sirineActive) return;

        let diff = Math.floor((nextAlarm - now) / 1000);
        let minutes = Math.floor(diff / 60);
        let seconds = diff % 60;

        const timeStr = nextAlarm.toTimeString().split(" ")[0].slice(0, 5);
        document.getElementById(
          "countdownText"
        ).innerHTML = `<i class="bi bi-broadcast-pin"></i> Alarm berikutnya: ${timeStr} (${minutes} menit ${seconds} detik lagi)`;
      }

      // ================== Jam Digital ===================

      function updateClock() {
        const now = new Date();
        let hours = now.getHours().toString().padStart(2, "0");
        let minutes = now.getMinutes().toString().padStart(2, "0");
        let seconds = now.getSeconds().toString().padStart(2, "0");
        document.getElementById(
          "clock"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      }

      // Initial call dan loop jam
      setInterval(updateClock, 1000);
      updateClock();
    </script>
  </body>
</html>
