<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Test Reminder, Sirine & Blok Nasional</title>
  </head>
  <body>
    <h1><div id="clock">00:00:00</div></h1>
    <h1>Test: Reminder (20s) + Sirine (60s) + Blok Nasional (90s)</h1>
    <button onclick="startTest()">Mulai</button>
    <button onclick="stopTest()">Stop</button>

    <!-- Info waktu mulai -->
    <p id="startTime">Waktu mulai: -</p>

    <p id="countdownBlock">Blok Nasional berikutnya: -</p>
    <p id="countdownSirine">Sirine berikutnya: -</p>
    <p id="countdownReminder">Reminder umum berikutnya: -</p>

    <!-- Reminder beep -->
    <audio id="reminderSound" src="chime-2-356833.mp3" preload="auto"></audio>

    <!-- Sirine -->
    <audio
      id="sirineSound"
      src="air-raid-siren-sound-effect-241383.mp3"
      preload="auto"
    ></audio>

    <!-- Indonesia Raya -->
    <audio
      id="indoSound"
      src="cut Indonesia Raya ðŸ‡®ðŸ‡©ðŸ‡®ðŸ‡© - Ciptaan W (mp3cut.net).mp3"
      preload="auto"
    ></audio>

    <!-- Hymne Sinarmas -->
    <audio
      id="anthemSound"
      src="cut version Hymne Sinar Mas - Sinar Ma.mp3"
      preload="auto"
    ></audio>

    <script>
      let checker;
      let reminderCountdownTimer;

      let sirineActive = false;
      let nationalBlockActive = false;

      // Interval (test mode)
      const reminderIntervalMs = 20000; // 20 detik
      const sirineIntervalMs = 60000; // 60 detik
      const blockIntervalMs = 90000; // 90 detik (patokan saja)

      let nextReminderTime = null;
      let nextSirineTime = null;
      let nextBlockTime = null;

      // ================== Start & Stop ==================
      function startTest() {
        if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }

        const now = new Date();
        document.getElementById(
          "startTime"
        ).innerText = `Waktu mulai: ${now.toLocaleTimeString("id-ID")}`;

        scheduleNextBlock();
        scheduleNextSirine();
        scheduleNextReminder();

        checker = setInterval(() => {
          checkBlock();
          checkSirine();
          checkReminder();
          updateCountdowns();
          updateClock();
        }, 500);

        alert(
          "Test dimulai: Reminder=20s, Sirine=60s, Blok Nasional=90s (prioritas: Blok > Sirine > Reminder)."
        );
      }

      function stopTest() {
        clearInterval(checker);
        clearInterval(reminderCountdownTimer);
        nextReminderTime = null;
        nextSirineTime = null;
        nextBlockTime = null;
        document.getElementById("countdownReminder").innerText =
          "Reminder umum berikutnya: -";
        document.getElementById("countdownSirine").innerText =
          "Sirine berikutnya: -";
        document.getElementById("countdownBlock").innerText =
          "Blok Nasional berikutnya: -";
        document.getElementById("startTime").innerText = "Waktu mulai: -";
      }

      // ================= Reminder =================
      function scheduleNextReminder() {
        const now = new Date();
        let candidate = new Date(now.getTime() + reminderIntervalMs);

        // kalau bentrok dengan Blok atau Sirine, geser
        while (
          (nextBlockTime && Math.abs(candidate - nextBlockTime) < 1000) ||
          (nextSirineTime && Math.abs(candidate - nextSirineTime) < 1000)
        ) {
          candidate = new Date(candidate.getTime() + reminderIntervalMs);
        }

        nextReminderTime = candidate;
        startReminderCountdown();
      }

      function checkReminder() {
        if (!nextReminderTime) return;
        const now = new Date();
        if (now >= nextReminderTime) {
          triggerReminder();
          scheduleNextReminder();
        }
      }

      function triggerReminder() {
        if (sirineActive || nationalBlockActive) {
          console.log(
            "Reminder dilewati karena Sirine / Blok Nasional sedang aktif."
          );
          return;
        }

        let reminder = document.getElementById("reminderSound");
        reminder.currentTime = 0;
        reminder.play();

        if (Notification.permission === "granted") {
          new Notification("Reminder!", {
            body: "Waktunya Reminder (test 20s)",
          });
        }
      }

      function startReminderCountdown() {
        clearInterval(reminderCountdownTimer);

        reminderCountdownTimer = setInterval(() => {
          if (!nextReminderTime) return;
          const now = new Date();
          let diff = Math.floor((nextReminderTime - now) / 1000);
          if (diff < 0) diff = 0;

          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownReminder"
          ).innerText = `Reminder umum berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }, 500);
      }

      // ================= Sirine =================
      function scheduleNextSirine() {
        const now = new Date();
        let candidate = new Date(now.getTime() + sirineIntervalMs);

        // kalau bentrok dengan Blok, geser
        while (nextBlockTime && Math.abs(candidate - nextBlockTime) < 1000) {
          candidate = new Date(candidate.getTime() + sirineIntervalMs);
        }

        nextSirineTime = candidate;
      }

      function checkSirine() {
        if (!nextSirineTime) return;
        const now = new Date();
        if (now >= nextSirineTime) {
          playSirine("Sirine berbunyi!");
          scheduleNextSirine();
        }
      }

      function playSirine(msg) {
        if (nationalBlockActive) {
          console.log("Sirine ditunda karena Blok Nasional sedang aktif.");
          return;
        }

        sirineActive = true;
        let sirine = document.getElementById("sirineSound");
        sirine.currentTime = 0;
        sirine.play();

        if (Notification.permission === "granted") {
          new Notification("Sirine!", { body: msg });
        }
        document.getElementById("countdownSirine").innerText = msg;

        // contoh durasi sirine 15 detik
        setTimeout(() => {
          sirine.pause();
          sirine.currentTime = 0;
          sirineActive = false;
        }, 15000);
      }

      // ================= Blok Nasional (Indonesia Raya + Hymne) =================
      function scheduleNextBlock() {
        const now = new Date();
        let candidate = new Date(now.getTime() + blockIntervalMs);
        nextBlockTime = candidate;
      }

      function checkBlock() {
        if (!nextBlockTime) return;
        const now = new Date();
        if (now >= nextBlockTime) {
          playNationalBlock("Blok Nasional dimulai (Indonesia Raya â†’ Hymne)!");
          scheduleNextBlock();
        }
      }

      function playNationalBlock(msg) {
        nationalBlockActive = true;

        let indo = document.getElementById("indoSound");
        let hymne = document.getElementById("anthemSound");

        if (Notification.permission === "granted") {
          new Notification("Blok Nasional!", { body: msg });
        }
        document.getElementById("countdownBlock").innerText = msg;

        // Mainkan Indonesia Raya
        indo.currentTime = 0;
        indo.play();

        // Kalau Indonesia Raya selesai â†’ langsung lanjut Hymne
        indo.onended = () => {
          indo.currentTime = 0;
          hymne.currentTime = 0;
          hymne.play();

          // Kalau Hymne selesai â†’ blok selesai
          hymne.onended = () => {
            hymne.currentTime = 0;
            nationalBlockActive = false;
          };
        };
      }

      // ================= Countdown & Clock =================
      function updateCountdowns() {
        const now = new Date();

        if (nextBlockTime) {
          let diff = Math.floor((nextBlockTime - now) / 1000);
          if (diff < 0) diff = 0;
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownBlock"
          ).innerText = `Blok Nasional berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }

        if (nextSirineTime) {
          let diff = Math.floor((nextSirineTime - now) / 1000);
          if (diff < 0) diff = 0;
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownSirine"
          ).innerText = `Sirine berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }
      }

      function updateClock() {
        const now = new Date();
        let hours = now.getHours().toString().padStart(2, "0");
        let minutes = now.getMinutes().toString().padStart(2, "0");
        let seconds = now.getSeconds().toString().padStart(2, "0");
        document.getElementById(
          "clock"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      }
    </script>
  </body>
</html>
