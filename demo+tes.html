<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Test Reminder & Sirine</title>
  </head>
  <body>
    <h1><div id="clock">00:00:00</div></h1>
    <h1>Test Reminder (20s) + Sirine (60s)</h1>
    <button onclick="startReminder()">Mulai</button>
    <button onclick="stopReminder()">Stop</button>

    <p id="countdownReminder">Reminder umum berikutnya: -</p>
    <p id="countdownText">Alarm berikutnya: -</p>

    <!-- Reminder beep -->
    <audio id="reminderSound" src="chime-2-356833.mp3" preload="auto"></audio>

    <!-- Sirine -->
    <audio
      id="sirineSound"
      src="air-raid-siren-sound-effect-241383.mp3"
      preload="auto"
    ></audio>

    <script>
      let checker;
      let reminderCountdownTimer;
      let sirineActive = false;

      // Interval reminder & sirine (test mode)
      const reminderIntervalMs = 20000; // 20 detik
      const sirineIntervalMs = 60000; // 60 detik

      let nextReminderTime = null;
      let nextSirineTime = null;

      function startReminder() {
        if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }

        scheduleNextReminder();
        scheduleNextSirine();

        checker = setInterval(() => {
          checkReminder();
          checkSirine();
          updateCountdowns();
        }, 500); // cek tiap 0.5 detik

        alert("Test dimulai: Reminder tiap 20 detik, Sirine tiap 60 detik.");
      }

      function stopReminder() {
        clearInterval(checker);
        clearInterval(reminderCountdownTimer);
        nextReminderTime = null;
        nextSirineTime = null;
        document.getElementById("countdownReminder").innerText =
          "Reminder umum berikutnya: -";
        document.getElementById("countdownText").innerText =
          "Alarm berikutnya: -";
      }

      // ================= Reminder =================
      function scheduleNextReminder() {
        const now = new Date();
        let candidate = new Date(now.getTime() + reminderIntervalMs);

        // kalau pas waktunya sama dengan sirine, geser ke 20 detik berikutnya
        while (nextSirineTime && Math.abs(candidate - nextSirineTime) < 1000) {
          candidate = new Date(candidate.getTime() + reminderIntervalMs);
        }

        nextReminderTime = candidate;
        startReminderCountdown();
      }

      function checkReminder() {
        if (!nextReminderTime) return;
        const now = new Date();
        if (now >= nextReminderTime) {
          triggerReminder();
          scheduleNextReminder();
        }
      }

      function triggerReminder() {
        if (sirineActive) {
          console.log("Reminder dilewati karena sirine sedang aktif.");
          scheduleNextReminder();
          return;
        }

        let reminder = document.getElementById("reminderSound");
        reminder.currentTime = 0;
        reminder.play();

        if (Notification.permission === "granted") {
          new Notification("Reminder!", {
            body: "Waktunya Reminder (test 20s)",
          });
        }
      }

      function startReminderCountdown() {
        clearInterval(reminderCountdownTimer);

        reminderCountdownTimer = setInterval(() => {
          if (!nextReminderTime) return;
          const now = new Date();
          let diff = Math.floor((nextReminderTime - now) / 1000);
          if (diff < 0) diff = 0;

          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownReminder"
          ).innerText = `Reminder umum berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }, 500);
      }

      // ================= Sirine =================
      function scheduleNextSirine() {
        const now = new Date();
        let candidate = new Date(now.getTime() + sirineIntervalMs);
        nextSirineTime = candidate;
      }

      function checkSirine() {
        if (!nextSirineTime) return;
        const now = new Date();
        if (now >= nextSirineTime) {
          playSirine("Sirine berbunyi!");
          scheduleNextSirine();
        }
      }

      function playSirine(msg) {
        sirineActive = true;

        let sirine = document.getElementById("sirineSound");
        sirine.currentTime = 0;
        sirine.play();

        if (Notification.permission === "granted") {
          new Notification("Sirine!", { body: msg });
        }
        document.getElementById("countdownText").innerText = msg;

        // Anggap durasi sirine 15 detik
        setTimeout(() => {
          sirine.pause();
          sirine.currentTime = 0;
          sirineActive = false;
        }, 15000);
      }

      // ================= Countdown =================
      function updateCountdowns() {
        // Update countdown sirine
        if (nextSirineTime) {
          const now = new Date();
          let diff = Math.floor((nextSirineTime - now) / 1000);
          if (diff < 0) diff = 0;

          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownText"
          ).innerText = `Sirine berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }
      }

      function updateClock() {
        const now = new Date();
        let hours = now.getHours().toString().padStart(2, "0");
        let minutes = now.getMinutes().toString().padStart(2, "0");
        let seconds = now.getSeconds().toString().padStart(2, "0");
        document.getElementById(
          "clock"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      }

      setInterval(updateClock, 1000);
      updateClock(); // panggil langsung pertama kali
    </script>
  </body>
</html>
