<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Test Reminder, Sirine & Hymne</title>
  </head>
  <body>
    <h1><div id="clock">00:00:00</div></h1>
    <h1>Test: Reminder (20s) + Sirine (60s) + Hymne Sinarmas (90s)</h1>
    <button onclick="startReminder()">Mulai</button>
    <button onclick="stopReminder()">Stop</button>

    <p id="countdownAnthem">Hymne Sinarmas berikutnya: -</p>
    <p id="countdownText">Sirine berikutnya: -</p>
    <p id="countdownReminder">Reminder umum berikutnya: -</p>

    <!-- Reminder beep -->
    <audio id="reminderSound" src="chime-2-356833.mp3" preload="auto"></audio>

    <!-- Sirine -->
    <audio
      id="sirineSound"
      src="air-raid-siren-sound-effect-241383.mp3"
      preload="auto"
    ></audio>

    <!-- Hymne Sinarmas -->
    <audio
      id="anthemSound"
      src="cut version Hymne Sinar Mas - Sinar Ma.mp3"
      preload="auto"
    ></audio>

    <script>
      let checker;
      let reminderCountdownTimer;
      let sirineActive = false;
      let anthemActive = false;

      // Interval (test mode)
      const reminderIntervalMs = 20000; // 20 detik
      const sirineIntervalMs = 60000; // 60 detik
      const anthemIntervalMs = 90000; // 90 detik

      // Durasi asli Hymne Sinarmas
      const anthemDuration = 145; // detik (2 menit 25 detik)

      let nextReminderTime = null;
      let nextSirineTime = null;
      let nextAnthemTime = null;

      function startReminder() {
        if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }

        scheduleNextAnthem();
        scheduleNextSirine();
        scheduleNextReminder();

        checker = setInterval(() => {
          checkAnthem();
          checkSirine();
          checkReminder();
          updateCountdowns();
          updateClock(); // update jam setiap 0.5 detik
        }, 500);

        alert(
          "Test dimulai: Reminder=20s, Sirine=60s, Hymne=90s (prioritas Hymne > Sirine > Reminder)."
        );
      }

      function stopReminder() {
        clearInterval(checker);
        clearInterval(reminderCountdownTimer);
        nextReminderTime = null;
        nextSirineTime = null;
        nextAnthemTime = null;
        document.getElementById("countdownReminder").innerText =
          "Reminder umum berikutnya: -";
        document.getElementById("countdownText").innerText =
          "Sirine berikutnya: -";
        document.getElementById("countdownAnthem").innerText =
          "Hymne Sinarmas berikutnya: -";
      }

      // ================= Reminder =================
      function scheduleNextReminder() {
        const now = new Date();
        let candidate = new Date(now.getTime() + reminderIntervalMs);

        // kalau bentrok dengan Hymne atau Sirine, geser
        while (
          (nextAnthemTime && Math.abs(candidate - nextAnthemTime) < 1000) ||
          (nextSirineTime && Math.abs(candidate - nextSirineTime) < 1000)
        ) {
          candidate = new Date(candidate.getTime() + reminderIntervalMs);
        }

        nextReminderTime = candidate;
        startReminderCountdown();
      }

      function checkReminder() {
        if (!nextReminderTime) return;
        const now = new Date();
        if (now >= nextReminderTime) {
          triggerReminder();
          scheduleNextReminder();
        }
      }

      function triggerReminder() {
        if (sirineActive || anthemActive) {
          console.log("Reminder dilewati karena sirine/hymne sedang aktif.");
          scheduleNextReminder();
          return;
        }

        let reminder = document.getElementById("reminderSound");
        reminder.currentTime = 0;
        reminder.play();

        if (Notification.permission === "granted") {
          new Notification("Reminder!", {
            body: "Waktunya Reminder (test 20s)",
          });
        }
      }

      function startReminderCountdown() {
        clearInterval(reminderCountdownTimer);

        reminderCountdownTimer = setInterval(() => {
          if (!nextReminderTime) return;
          const now = new Date();
          let diff = Math.floor((nextReminderTime - now) / 1000);
          if (diff < 0) diff = 0;

          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownReminder"
          ).innerText = `Reminder umum berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }, 500);
      }

      // ================= Sirine =================
      function scheduleNextSirine() {
        const now = new Date();
        let candidate = new Date(now.getTime() + sirineIntervalMs);

        // kalau bentrok dengan Hymne, geser
        while (nextAnthemTime && Math.abs(candidate - nextAnthemTime) < 1000) {
          candidate = new Date(candidate.getTime() + sirineIntervalMs);
        }

        nextSirineTime = candidate;
      }

      function checkSirine() {
        if (!nextSirineTime) return;
        const now = new Date();
        if (now >= nextSirineTime) {
          playSirine("Sirine berbunyi!");
          scheduleNextSirine();
        }
      }

      function playSirine(msg) {
        if (anthemActive) {
          console.log("Sirine ditunda karena Hymne sedang aktif.");
          return;
        }

        sirineActive = true;
        let sirine = document.getElementById("sirineSound");
        sirine.currentTime = 0;
        sirine.play();

        if (Notification.permission === "granted") {
          new Notification("Sirine!", { body: msg });
        }
        document.getElementById("countdownText").innerText = msg;

        // Anggap durasi sirine 15 detik
        setTimeout(() => {
          sirine.pause();
          sirine.currentTime = 0;
          sirineActive = false;
        }, 15000);
      }

      // ================= Hymne =================
      function scheduleNextAnthem() {
        const now = new Date();
        let candidate = new Date(now.getTime() + anthemIntervalMs);
        nextAnthemTime = candidate;
      }

      function checkAnthem() {
        if (!nextAnthemTime) return;
        const now = new Date();
        if (now >= nextAnthemTime) {
          playAnthem("Hymne Sinarmas dimulai!");
          scheduleNextAnthem();
        }
      }

      function playAnthem(msg) {
        anthemActive = true;
        let anthem = document.getElementById("anthemSound");
        anthem.currentTime = 0;
        anthem.play();

        if (Notification.permission === "granted") {
          new Notification("Hymne Sinarmas!", { body: msg });
        }
        document.getElementById("countdownAnthem").innerText = msg;

        setTimeout(() => {
          anthem.pause();
          anthem.currentTime = 0;
          anthemActive = false;
        }, anthemDuration * 1000);
      }

      // ================= Countdown =================
      function updateCountdowns() {
        const now = new Date();

        // Hymne
        if (nextAnthemTime) {
          let diff = Math.floor((nextAnthemTime - now) / 1000);
          if (diff < 0) diff = 0;
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownAnthem"
          ).innerText = `Hymne Sinarmas berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }

        // Sirine
        if (nextSirineTime) {
          let diff = Math.floor((nextSirineTime - now) / 1000);
          if (diff < 0) diff = 0;
          let minutes = Math.floor(diff / 60);
          let seconds = diff % 60;
          document.getElementById(
            "countdownText"
          ).innerText = `Sirine berikutnya: ${minutes} menit ${seconds} detik lagi`;
        }
      }

      // ================= Clock =================
      function updateClock() {
        const now = new Date();
        let hours = now.getHours().toString().padStart(2, "0");
        let minutes = now.getMinutes().toString().padStart(2, "0");
        let seconds = now.getSeconds().toString().padStart(2, "0");
        document.getElementById(
          "clock"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      }
    </script>
  </body>
</html>
